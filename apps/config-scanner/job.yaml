apiVersion: batch/v1
kind: Job
metadata:
  name: config-scanning
spec:
  template:
    spec:
      serviceAccountName: s3-access
      volumes:
        - name: secret-volume
          secret:
            secretName: dotfile-secret
      containers:
        - name: harvest-root
          volumeMounts:
            - name: secret-volume
              readOnly: true
              mountPath: "/etc/secret-volume"
          env:
            - name: app-id-file
              value: "app-id"
            - name: app-private-key-file
              value: "app-private-key"
          image: public.ecr.aws/n1b3o1k2/config-scanning:0.0.4
          command: ["python3", "-m", "configscanning.repoupdater", "https://github.com/UKEODHP/catalogue-data/", "/tmp", "--app-id-from", "app-id", "--app-private-key-from", "app-private-key", "--pull"]
        - name: ingest-root
#          env:
#            - name: AWS_ACCESS_KEY
#              value:
#            - name: AWS_SECRET_ACCESS_KEY
#              value:
          image: public.ecr.aws/n1b3o1k2/config-scanning:0.0.4
          command: ["python3", "-m", "configscanning.comparefiles", "/tmp/catalogue-data/", "catalogue-data", "", ""]
      restartPolicy: Never
  backoffLimit: 4
---
apiVersion: v1
kind: Secret
metadata:
  name: dotfile-secret
data:
  app-id: ${{ secrets.APP_ID }}
  app-private-key: ${{ secrets.APP_PRIVATE_KEY }}
